name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    name: Build & Release
    runs-on: macos-14

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'

    - name: Determine version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${{ github.ref_name }}"
        fi
        # Strip leading 'v' for plain version number
        PLAIN_VERSION="${VERSION#v}"
        echo "tag=$VERSION" >> $GITHUB_OUTPUT
        echo "plain=$PLAIN_VERSION" >> $GITHUB_OUTPUT

    - name: Write VERSION file
      run: echo "${{ steps.version.outputs.plain }}" > VERSION

    - name: Generate Version.swift
      run: ./scripts/generate-version.sh

    - name: Build release binary
      run: swift build -c release

    - name: Create archives
      id: archive
      run: |
        cp .build/release/envpocket ./envpocket
        tar -czf envpocket-macos.tar.gz envpocket
        zip envpocket-macos.zip envpocket

        SHA256=$(shasum -a 256 envpocket-macos.tar.gz | awk '{print $1}')
        echo "sha256=$SHA256" >> $GITHUB_OUTPUT

        shasum -a 256 envpocket-macos.tar.gz > checksums.txt
        shasum -a 256 envpocket-macos.zip >> checksums.txt

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: envpocket ${{ steps.version.outputs.tag }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          envpocket-macos.tar.gz
          envpocket-macos.zip
          checksums.txt
        body: |
          ## Installation

          ### Using Homebrew (Recommended)
          ```bash
          brew install thieso2/tap/envpocket
          ```

          ### Manual installation
          1. Download `envpocket-macos.tar.gz`
          2. Extract: `tar xzf envpocket-macos.tar.gz`
          3. Move to PATH: `sudo cp envpocket /usr/local/bin/`

          ## Checksums
          See `checksums.txt` for SHA-256 checksums.

    - name: Push formula to Homebrew tap
      env:
        TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
      run: |
        VERSION="${{ steps.version.outputs.plain }}"
        SHA256="${{ steps.archive.outputs.sha256 }}"

        # Generate formula
        cat > /tmp/envpocket.rb << FORMULA
        class Envpocket < Formula
          desc "Secure environment file storage in macOS Keychain"
          homepage "https://github.com/thieso2/envpocket"
          url "https://github.com/thieso2/envpocket/releases/download/v#{version}/envpocket-macos.tar.gz"
          sha256 "${SHA256}"
          version "${VERSION}"
          license "MIT"

          def install
            bin.install "envpocket"
          end

          test do
            assert_match version.to_s, shell_output("#{bin}/envpocket --version")
          end
        end
        FORMULA

        # Clone tap repo and push formula
        git clone "https://x-access-token:${TAP_TOKEN}@github.com/thieso2/homebrew-tap.git" /tmp/homebrew-tap
        mkdir -p /tmp/homebrew-tap/Formula
        cp /tmp/envpocket.rb /tmp/homebrew-tap/Formula/envpocket.rb
        cd /tmp/homebrew-tap
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add Formula/envpocket.rb
        git commit -m "Update envpocket to ${VERSION}"
        git push
