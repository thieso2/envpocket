# mise configuration for envpocket
# https://mise.jdx.dev/

[tools]
# swift is typically managed by Xcode, not mise

[tasks."gen:version"]
description = "Generate version information"
run = "./scripts/generate-version.sh"

[tasks.build]
description = "Build debug version"
depends = ["gen:version"]
run = "swift build"

[tasks."build:release"]
description = "Build optimized release version"
depends = ["gen:version"]
run = "swift build -c release"

[tasks.test]
description = "Run all tests"
depends = ["gen:version"]
run = "swift test"

[tasks."test:verbose"]
description = "Run tests with verbose output"
depends = ["gen:version"]
run = "swift test --verbose"

[tasks.clean]
description = "Clean build artifacts"
run = "swift package clean"

[tasks.install]
description = "Install to /usr/local/bin (requires sudo)"
depends = ["build:release"]
run = """
#!/usr/bin/env bash
set -euo pipefail
sudo cp .build/release/envpocket /usr/local/bin/
echo "✓ Installed envpocket to /usr/local/bin/"
"""

[tasks."install:local"]
description = "Install to ~/.local/bin (no sudo required)"
depends = ["build:release"]
run = """
#!/usr/bin/env bash
set -euo pipefail
mkdir -p ~/.local/bin
cp .build/release/envpocket ~/.local/bin/
echo "✓ Installed envpocket to ~/.local/bin/"
echo "  Make sure ~/.local/bin is in your PATH"
"""

[tasks.run]
description = "Run envpocket (usage: mise run run -- <args>)"
run = "swift run envpocket"

[tasks.lint]
description = "Check for compilation warnings"
run = """
#!/usr/bin/env bash
set -euo pipefail
if swift build -c release 2>&1 | grep -i warning; then
  echo "⚠️  Warnings found!"
  exit 1
else
  echo "✓ No warnings found"
fi
"""

[tasks.version]
description = "Show current version from formula"
run = """
#!/usr/bin/env bash
grep 'version "' Formula/envpocket.rb | sed 's/.*version "\\(.*\\)"/\\1/'
"""

[tasks."release:archive"]
description = "Create release archive for distribution"
depends = ["clean", "build:release"]
run = """
#!/usr/bin/env bash
set -euo pipefail

VERSION=$(grep 'version "' Formula/envpocket.rb | sed 's/.*version "\\(.*\\)"/\\1/')
ARCHIVE="envpocket-macos.tar.gz"

echo "Creating release archive for version $VERSION..."

# Create archive
tar -czf "$ARCHIVE" -C .build/release envpocket

# Calculate SHA256
SHA256=$(shasum -a 256 "$ARCHIVE" | awk '{print $1}')

echo ""
echo "✓ Created: $ARCHIVE"
echo "  SHA256: $SHA256"
echo ""
echo "Next steps:"
echo "  1. Create GitHub release: gh release create v$VERSION $ARCHIVE"
echo "  2. Update Formula/envpocket.rb with new SHA256: $SHA256"
echo "  3. Commit and push the formula update"
"""

[tasks."release:formula"]
description = "Update formula with new version and SHA256"
run = """
#!/usr/bin/env bash
set -euo pipefail

if [ $# -lt 2 ]; then
  echo "Usage: mise run release:formula <version> <sha256>"
  echo "Example: mise run release:formula 0.4.2 abc123..."
  exit 1
fi

VERSION="$1"
SHA256="$2"

echo "Updating Formula/envpocket.rb..."
echo "  Version: $VERSION"
echo "  SHA256: $SHA256"

# Use template-based update script
./scripts/update-formula.sh "$VERSION" "$SHA256"

echo ""
echo "Review changes with: git diff Formula/envpocket.rb"
"""

[tasks."release:publish"]
description = "Full release workflow (usage: mise run release:publish [VERSION])"
depends = ["test", "lint"]
run = """
#!/usr/bin/env bash
set -euo pipefail

# Get current version from Formula (strip quotes)
CURRENT_VERSION=$(grep -E '^[[:space:]]*version[[:space:]]+' Formula/envpocket.rb | awk '{print $2}' | tr -d '"')

echo "Current version: $CURRENT_VERSION"

# Get new version from argument or prompt
if [ $# -ge 1 ]; then
  NEW_VERSION="$1"
  echo "New version (from argument): $NEW_VERSION"
else
  echo -n "Enter new version: "
  read NEW_VERSION < /dev/tty
fi

if [ -z "$NEW_VERSION" ]; then
  echo "Error: Version required"
  exit 1
fi

# Validate version format (X.Y.Z)
if ! echo "$NEW_VERSION" | grep -qE '^[0-9]+[.][0-9]+[.][0-9]+$'; then
  echo "Error: Version must be in format X.Y.Z (e.g., 0.5.3)"
  exit 1
fi

# Compare versions - ensure new version is greater than current
if [ "$(printf '%s\n' "$CURRENT_VERSION" "$NEW_VERSION" | sort -V | tail -1)" = "$CURRENT_VERSION" ]; then
  echo "Error: New version ($NEW_VERSION) must be greater than current version ($CURRENT_VERSION)"
  exit 1
fi

echo "✓ Version validation passed ($CURRENT_VERSION → $NEW_VERSION)"
echo ""
echo "Publishing version $NEW_VERSION..."
echo ""

# Clean and build (will use NEW version from Formula)
echo "→ Cleaning and building with version $NEW_VERSION..."
mise run clean
mise run build:release

# Create archive
echo ""
echo "→ Creating release archive..."
ARCHIVE="envpocket-macos.tar.gz"
tar -czf "$ARCHIVE" -C .build/release envpocket
SHA256=$(shasum -a 256 "$ARCHIVE" | awk '{print $1}')

echo "  Archive: $ARCHIVE"
echo "  SHA256: $SHA256"

# Update Formula with version and SHA256 (from template)
echo ""
echo "→ Updating Formula from template..."
./scripts/update-formula.sh "$NEW_VERSION" "$SHA256"

# Create GitHub release
echo ""
echo "→ Creating GitHub release..."
if ! gh release create "v$NEW_VERSION" "$ARCHIVE" --title "v$NEW_VERSION" --generate-notes; then
  echo "Error: Failed to create GitHub release"
  exit 1
fi

# Commit and push
echo ""
echo "→ Committing formula update..."
git add Formula/envpocket.rb
git commit -m "Update Homebrew formula to v$NEW_VERSION"
git push

echo ""
echo "✓ Release v$NEW_VERSION published successfully!"
echo ""
echo "Users can now install with:"
echo "  brew upgrade envpocket"
"""

[tasks.dev]
description = "Development workflow: build and test"
depends = ["build", "test"]

[tasks.ci]
description = "CI workflow: lint, test, build release"
depends = ["lint", "test", "build:release"]
