# mise configuration for envpocket
# https://mise.jdx.dev/

[tools]
# swift is typically managed by Xcode, not mise

[tasks."gen:version"]
description = "Generate version information"
run = "./scripts/generate-version.sh"

[tasks.build]
description = "Build debug version"
depends = ["gen:version"]
run = "swift build"

[tasks."build:release"]
description = "Build optimized release version"
depends = ["gen:version"]
run = "swift build -c release"

[tasks.test]
description = "Run all tests"
depends = ["gen:version"]
run = "swift test"

[tasks."test:verbose"]
description = "Run tests with verbose output"
depends = ["gen:version"]
run = "swift test --verbose"

[tasks.clean]
description = "Clean build artifacts"
run = "swift package clean"

[tasks.install]
description = "Install to /usr/local/bin (requires sudo)"
depends = ["build:release"]
run = """
#!/usr/bin/env bash
set -euo pipefail
sudo cp .build/release/envpocket /usr/local/bin/
echo "✓ Installed envpocket to /usr/local/bin/"
"""

[tasks."install:local"]
description = "Install to ~/.local/bin (no sudo required)"
depends = ["build:release"]
run = """
#!/usr/bin/env bash
set -euo pipefail
mkdir -p ~/.local/bin
cp .build/release/envpocket ~/.local/bin/
echo "✓ Installed envpocket to ~/.local/bin/"
echo "  Make sure ~/.local/bin is in your PATH"
"""

[tasks.run]
description = "Run envpocket (usage: mise run run -- <args>)"
run = "swift run envpocket"

[tasks.lint]
description = "Check for compilation warnings"
run = """
#!/usr/bin/env bash
set -euo pipefail
if swift build -c release 2>&1 | grep -i warning; then
  echo "⚠️  Warnings found!"
  exit 1
else
  echo "✓ No warnings found"
fi
"""

[tasks.version]
description = "Show current version from VERSION file"
run = """
#!/usr/bin/env bash
cat VERSION
"""

[tasks."release:publish"]
description = "Tag and push a new release (triggers CI workflow)"
depends = ["test", "lint"]
run = """
#!/usr/bin/env bash
set -euo pipefail

CURRENT_VERSION=$(tr -d '[:space:]' < VERSION)
echo "Current version: $CURRENT_VERSION"

# Get new version from argument or prompt
if [ $# -ge 1 ]; then
  NEW_VERSION="$1"
  echo "New version (from argument): $NEW_VERSION"
else
  echo -n "Enter new version: "
  read NEW_VERSION < /dev/tty
fi

if [ -z "$NEW_VERSION" ]; then
  echo "Error: Version required"
  exit 1
fi

# Validate version format (X.Y.Z)
if ! echo "$NEW_VERSION" | grep -qE '^[0-9]+[.][0-9]+[.][0-9]+$'; then
  echo "Error: Version must be in format X.Y.Z (e.g., 0.5.3)"
  exit 1
fi

# Compare versions - ensure new version is greater than current
if [ "$(printf '%s\n' "$CURRENT_VERSION" "$NEW_VERSION" | sort -V | tail -1)" = "$CURRENT_VERSION" ]; then
  echo "Error: New version ($NEW_VERSION) must be greater than current version ($CURRENT_VERSION)"
  exit 1
fi

echo "✓ Version validation passed ($CURRENT_VERSION → $NEW_VERSION)"
echo ""

# Update VERSION file
echo "$NEW_VERSION" > VERSION
git add VERSION
git commit -m "Bump version to $NEW_VERSION"
git push

# Create and push tag (triggers release workflow)
echo "→ Creating tag v$NEW_VERSION..."
git tag "v$NEW_VERSION"
git push origin "v$NEW_VERSION"

echo ""
echo "✓ Tag v$NEW_VERSION pushed — CI will build & publish the release."
echo "  Monitor: https://github.com/thieso2/envpocket/actions"
"""

[tasks.dev]
description = "Development workflow: build and test"
depends = ["build", "test"]

[tasks.ci]
description = "CI workflow: lint, test, build release"
depends = ["lint", "test", "build:release"]
